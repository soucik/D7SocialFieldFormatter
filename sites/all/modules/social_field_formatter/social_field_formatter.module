<?php
/**
 * HELP HOOK - Displays help and module information.
 */
function social_field_formatter_help($path, $arg) {
	if ($path == 'admin/help#social_field_formatter') {
		return '<p>' . t('Module rearrange view of values in Social field inside Company node. It adds icons to links pointing to social sites.'). '</p>';
	}
}

/**
* Implements hook_field_formatter_info().
*/
function social_field_formatter_field_formatter_info() {
	return array(
	'social_field_formatter_formatter' => array( 
		'label' => t('Social field'),
		'field types' => array('text'),
		'settings' => array(
			'type' => 'icon',
			'size' => 'default'
			),
		),
	);
}

/**
* Implements hook_field_formatter_settings_form().
*/
function social_field_formatter_field_formatter_settings_form($field, $instance, $view_mode, $form, &$form_state) {
	$display = $instance['display'][$view_mode];
	$settings = $display['settings'];
	$element = array();

	$element['type'] = array(
		'#type' => 'select',
		'#title' => t('Type'),
		'#description' => t('Select what type of link will be shown.'),
		'#default_value' => $settings['type'],
		'#options' => array(
			'icon' => 'Icon',
			'text' => 'Text',
			'both' => 'Both',
		),
	);

	$element['size'] = array(
		'#type' => 'select',
		'#title' => t('Size'),
		'#description' => t('Select what size of social icon will be used.'),
		'#default_value' => $settings['size'],
		'#options' => array(
			'default' => 'Default',
			'large' => 'Large',
		),
	);
	return $element;
}

/**
* hook_field_formatter_settings_summary
*/
function social_field_formatter_field_formatter_settings_summary($field, $instance, $view_mode) {
	$display = $instance['display'][$view_mode];
	$settings = $display['settings'];
	$summary = t('Use a @type link option for link type with the icon size of "@size"', array(
		'@type' => $settings['type'],
		'@size' => $settings['size']
	));
	return $summary;
}

/**
* Implements hook_field_formatter_view().
*/
function social_field_formatter_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
	$element = array();
	$settings = $display['settings'];
	$icons_size_class = ($settings['size'] == 'large')? 'fa-2x':'fa-lg';
	$suffix_link_social = '</a>';
	switch($settings['type'])
	{
	case 'text':
		foreach ($items as $delta => $item) {
			$item_link_social = $item['safe_value'];
			$prefix_link_social = '<a href ="'.$item_link_social.'">';
			$element[$delta] = _make_link($prefix_link_social, $item_link_social, $suffix_link_social);
		}
		break;
	case 'both':
		$icons_size_class = 'fa-lg';
		foreach ($items as $delta => $item) {
			$item_link_social = $item['safe_value'];
			$prefix_link_social = '<a href ="'.$item_link_social.'">';
			$font_awesome_social_class = _attach_icon($item_link_social, $icons_size_class);
			$item_link_social = '<i class="'.$font_awesome_social_class.'" aria-hidden="true"></i> '.$item['safe_value'];
			$element[$delta] = _make_link($prefix_link_social, $item_link_social, $suffix_link_social);
		}
		break;
	case 'icon':
		foreach ($items as $delta => $item) {
			$item_link_social = $item['safe_value'];
			$prefix_link_social = '<a href ="'.$item_link_social.'">';
			$font_awesome_social_class = _attach_icon($item_link_social, $icons_size_class);
			$item_link_social = '<i class="'.$font_awesome_social_class.'" aria-hidden="true"></i>';
			$element[$delta] = _make_link($prefix_link_social, $item_link_social, $suffix_link_social);
		}
		break;
	}
	return $element;
}

function _parse_link_domain($link){
	$particular_link = preg_replace('#^https?://#', '', $link); //remove http://, https://
	$particular_link = preg_replace('#^www.#', '', $particular_link); //remove www.
	$iPosition = strpos($particular_link, '.com'); //remove characters from beggining .com
	if ($iPosition !== false)
		return substr($particular_link, 0, $iPosition);
	else
		return $particular_link;
}

function _attach_icon($item_link_social, $icon_size_class){
		$font_awesome_social_class = '';
		$social_domain_name = _parse_link_domain($item_link_social);
		switch($social_domain_name){
		case 'facebook':
			$font_awesome_social_class = "fa fa-facebook";
			break;
		case 'linkedin':
			$font_awesome_social_class = "fa fa-linkedin";
			break;
		case 'plus.google':
			$font_awesome_social_class = "fa fa-google-plus";
			break;
		default:
			$font_awesome_social_class = "fa fa-globe";
			break;
		}
	return $font_awesome_social_class.' '.$icon_size_class; 
}

function _make_link($prefix_link_social, $item_link_social, $suffix_link_social){
	return array(
		'#prefix' => $prefix_link_social,
		'#markup' => $item_link_social,
		'#suffix' => $suffix_link_social);
}